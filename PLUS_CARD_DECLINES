WITH base as (
select 
issuer_id attempt_id,  
to_date(date_trunc('day', convert_timezone('UTC', 'America/Los_Angeles',dateadd('ms',event_info_event_time,'1970-01-01')))) AS attempt_date,
REASON_CODE
from AP_RAW_GREEN.GREEN.RAW_P_E_CARD_TRANSACTION
where card_type = 'ANYWHERE' 
and type = 'AUTH' 
and processing_status <> 'PEND'
AND STATE = 'DECL'
AND country_code = 'US'
AND attempt_date BETWEEN '2024-06-01' AND '2024-08-30'
AND amount_amount>0
AND REASON_CODE IN 
('CONSUMER_APPLE_PAY_NOT_SUPPORTED',
'CONSUMER_CARD_EXPIRY',
'CONSUMER_CASH_APP_PAY_NOT_SUPPORTED',
'CONSUMER_NO_CARD_ON_FILE',
'CONSUMER_PROFILE_INCOMPLETE',
'CREDIT_CHECK_DECLINE',
'DEADLINE_EXCEEDED',
'DECLINED_GOOGLE_PAY_ECOMMERCE_TRANSACTION',
'DECLINED_SAMSUNG_PAY_ECOMMERCE_TRANSACTION',
'EXCESSIVE_LATE_FEE_AMOUNT',
'EXCESSIVE_LATE_FEE_NUMBER',
'FRAUD_CHECKER_DECLINE',
'ID_CHECK_REQUIRED',
'INVALID_CURRENCY_FOR_COUNTRY',
'LOCK_ACQUISITION_FAILURE',
'MAX_ACTIVE_ORDERS_REACHED',
'MERCHANT_BLOCKED',
'MERCHANT_NOT_FOUND',
'MQ_RESTRICTED_MCC',
'ORDER_AMOUNT_EXCEEDS_OPEN_TO_BUY_AMOUNT',
'ORDER_AMOUNT_EXCEEDS_OTB_MINUS_TIP_BUFFER',
'ORDER_AMOUNT_GREATER_THAN_MAX_ALLOWED',
'ORDER_AMOUNT_TOO_SMALL',
'OTB_EXCEEDED_PAYMENT_REQUIRED',
'STORE_BLOCKED',
'STORE_REFUND_ONLY',
'TOPAZ_CONNECT_OR_READ_TIMEOUT',
'TOPAZ_DECLINE_OR_FAILURE',
'TOPAZ_INSUFFICIENT_FUNDS',
'MERCHANT_CHANNEL_SETUP_ERROR',
'ORDER_AMOUNT_LESS_THAN_MIN_ALLOWED',
'MERCHANT_COMPLIANCE_VERIFICATION_NOT_COMPLETED',
'UNSUPPORTED_CARD_TYPE_CDC',
'TERMINAL_NOT_FOUND',
'TRANSACTIONS_NOT_ALLOWED_FROM_THIS_COUNTRY',
'MERCHANT_NOT_ENABLED',
'MERCHANT_UNSUPPORTED_CURRENCY',
'OPEN_TO_BUY_NOT_FOUND',
'DSS_RESTRICTED_COF'
))

select REASON_CODE, count(attempt_id) from base group by 1
